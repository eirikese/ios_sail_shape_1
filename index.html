<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, 
                 user-scalable=no, 
                 minimum-scale=1.0, 
                 maximum-scale=1.0" />
  <title>Grayscale Video with Configurable IP</title>
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
</head>
<body>
  <h1>Grayscale Video (IP Config)</h1>

  <!-- 
    1) The user enters the server's IP address here.
    2) Once "Set IP" is clicked, the code updates the API URL internally.
    3) Then, "Start Camera" triggers the camera and processes frames using that URL.
  -->
  <div style="margin-bottom: 1em;">
    <label for="ipInput">Server IP/Domain:</label>
    <input type="text" id="ipInput" placeholder="e.g. 192.168.10.167" />
    <button onclick="setApiUrl()">Set IP</button>
  </div>

  <button id="startButton" onclick="startVideo()">Start Camera</button>

  <!-- iOS-specific attributes for inline video -->
  <video 
    id="video" 
    playsinline 
    webkit-playsinline 
    autoplay 
    style="display: none;"
  ></video>

  <canvas id="canvas" width="640" height="480"></canvas>

  <script>
    let video;
    let canvas;
    let ctx;

    // We'll store the final /process_frame API endpoint here
    let apiEndpoint = '';

    function setApiUrl() {
      const ip = document.getElementById('ipInput').value.trim();
      if (!ip) {
        alert("Please enter a valid IP or domain name.");
        return;
      }

      // For HTTPS on port 5000; adjust if needed:
      apiEndpoint = `https://${ip}:5000/process_frame`;
      console.log('[setApiUrl] API endpoint set to:', apiEndpoint);
      alert(`API endpoint set to: ${apiEndpoint}`);
    }

    async function processFrame() {
      if (!apiEndpoint) {
        console.error('[processFrame] API endpoint not set! Please enter IP and click "Set IP".');
        return;
      }

      try {
        console.log('[processFrame] Capturing a frame from video...');
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

        // Convert the canvas content to a JPEG in Base64
        const frameDataURL = canvas.toDataURL('image/jpeg');
        console.log('[processFrame] frameDataURL length:', frameDataURL.length);

        // Convert the Base64 to binary data
        const binaryString = atob(frameDataURL.split(',')[1]);
        const arrayBuffer = new Uint8Array(binaryString.length);
        for (let i = 0; i < binaryString.length; i++) {
          arrayBuffer[i] = binaryString.charCodeAt(i);
        }
        console.log('[processFrame] Binary frame created, length:', arrayBuffer.length);

        // Send the frame to the Flask server
        console.log('[processFrame] Sending frame to:', apiEndpoint);
        const response = await fetch(apiEndpoint, {
          method: 'POST',
          headers: { 'Content-Type': 'application/octet-stream' },
          body: arrayBuffer
        });

        const data = await response.json();
        console.log('[processFrame] Response from API:', data);

        if (response.ok && data.processed_frame) {
          const processedImageBase64 = data.processed_frame;
          console.log('[processFrame] Processed image base64 length:', processedImageBase64.length);

          // Create an image element for the processed frame
          const img = new Image();
          img.src = 'data:image/jpeg;base64,' + processedImageBase64;

          img.onload = () => {
            console.log('[processFrame] Drawing processed grayscale image on canvas...');
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
          };
        } else {
          console.error('[processFrame] Error from API:', data.error);
        }
      } catch (error) {
        console.error('[processFrame] Error in API call:', error);
      }
    }

    async function startVideo() {
      console.log('[startVideo] Attempting to access camera...');
      video = document.getElementById('video');
      canvas = document.getElementById('canvas');
      ctx = canvas.getContext('2d');

      // For iOS, must be triggered by a user gesture
      try {
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: "user" },
          audio: false
        });
        console.log('[startVideo] Camera access granted!');
        video.srcObject = stream;

        document.getElementById('startButton').style.display = 'none';

        // Process frames at intervals (100ms = 10 fps)
        setInterval(processFrame, 100);
      } catch (err) {
        console.error('[startVideo] Error accessing camera:', err);
        alert('Failed to access camera. Please check permissions and reload the page.');
      }
    }
  </script>
</body>
</html>
